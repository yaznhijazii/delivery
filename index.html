<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Delivery Dashboard — Manual Processing</title>

<!-- XLSX -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<!-- Tajawal font -->
<link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;700&display=swap" rel="stylesheet">

<style>
:root{
  --bg:#f6f8fb; --card:#fff; --primary:#0b67ff; --accent:#1cc4a5; --muted:#98a2b3; --radius:12px;
}
*{box-sizing:border-box}
body{margin:0;font-family:'Tajawal',sans-serif;background:var(--bg);color:#0f1724}
header{background:linear-gradient(90deg,var(--primary),#24c0ff 70%);color:white;padding:28px 20px;border-bottom-left-radius:18px;border-bottom-right-radius:18px;box-shadow:0 8px 30px rgba(11,103,255,0.12)}
header h1{margin:0;font-weight:700;font-size:1.6rem}
header p{margin:6px 0 0;font-weight:500;opacity:0.9}
.greeting{overflow:hidden;white-space:nowrap;font-weight:600;margin-top:8px}
.greeting .text{display:inline-block;transform:translateX(-120%);animation:slidein 1s cubic-bezier(.22,.9,.33,1) forwards;font-size:1.05rem}
@keyframes slidein{to{transform:translateX(0%)}}
.wrap{max-width:1100px;margin:26px auto;padding:18px}
.grid{display:grid;grid-template-columns:1fr 420px;gap:18px}
.panel{background:var(--card);border-radius:var(--radius);padding:16px;box-shadow:0 6px 22px rgba(15,23,36,0.06)}
.sheet-row{display:flex;align-items:center;gap:12px;padding:12px;border-radius:10px;border:1px dashed #e6eef9;margin-bottom:12px}
.sheet-left{flex:1}
.sheet-left strong{display:block;font-weight:700}
.sheet-left small{display:block;color:var(--muted);margin-top:4px;font-size:0.86rem}
.sheet-actions{display:flex;flex-direction:column;gap:8px;align-items:flex-end}
input[type=file]{padding:10px;border-radius:8px;border:1px solid #e8f0ff;background:#f7fbff;cursor:pointer}
.btn{background:var(--primary);color:white;padding:9px 12px;border-radius:9px;border:none;cursor:pointer;font-weight:600}
.btn.secondary{background:var(--accent)}
.btn.ghost{background:transparent;color:var(--primary);border:1px solid rgba(11,103,255,0.18)}
.btn:disabled{opacity:0.5;cursor:not-allowed}
.progress-wrapper{width:220px}
.progress{width:100%;height:8px;background:#eef6ff;border-radius:999px;overflow:hidden}
.bar{height:100%;width:0%;background:linear-gradient(90deg,var(--accent),#19b3a0);transition:width .35s ease}
.spinner{width:22px;height:22px;border-radius:50%;border:3px solid rgba(0,0,0,0.08);border-top-color:var(--primary);animation:spin .9s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}
.summary .card{background:linear-gradient(180deg,#fff,#fbfeff);border-radius:12px;padding:14px;box-shadow:0 6px 18px rgba(15,23,36,0.04);margin-bottom:12px}
.report-table{width:100%;border-collapse:collapse;font-size:0.95rem}
.report-table th{ text-align:left;padding:8px;background:rgba(11,103,255,0.12);color:var(--primary);font-weight:700}
.report-table td{padding:8px;border-bottom:1px solid #f1f6fb}
.preview{max-height:300px;overflow:auto;border-radius:10px;border:1px solid #edf4ff;padding:10px}
table.preview-table{width:100%;border-collapse:collapse;font-size:0.92rem}
table.preview-table th{background:#f3f8ff;color:var(--primary);padding:8px;text-align:left}
table.preview-table td{padding:8px;border-bottom:1px solid #f5f7fb}
footer{margin-top:20px;text-align:center;color:#6b7280;font-size:0.9rem}
.brand{font-weight:700;color:var(--primary)}
.controls-row{display:flex;gap:12px;align-items:center;flex-wrap:wrap;margin-top:10px}
@media (max-width:980px){.grid{grid-template-columns:1fr}.progress-wrapper{width:140px}}
</style>
</head>
<body>
<header>
  <div class="wrap title-row" style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap">
    <div>
      <h1>Delivery Dashboard</h1>
      <p class="subtitle">Upload, Process & Inspect deliveries — you control downloads</p>
      <div class="greeting"><span class="text" id="greetingText">مرحباً Waad!</span></div>
    </div>
    <div style="text-align:right">
      <div style="font-size:0.95rem;opacity:0.85" id="timeNow"></div>
    </div>
  </div>
</header>

<main class="wrap">
<div class="grid">
  <!-- LEFT: upload -->
  <div>
    <div class="panel">
      <h3>Upload sheets (per company)</h3>
      <p style="color:var(--muted)">رفع كل ملف لوحده — اضغط "Process" لمعالجة. التنزيل سيكون يدوياً.</p>
      <div id="sheetsContainer"></div>
      <div class="controls-row">
        <button id="downloadMergedBtn" class="btn" disabled>Download Merged</button>
        <button id="clearAllBtn" class="btn ghost">Clear All</button>
      </div>
      <div style="margin-top:14px;color:var(--muted);font-size:0.9rem">
        <strong>ملاحظة:</strong> الملفات لا تُنزل تلقائياً.
      </div>
    </div>

    <!-- Quick Tips منفصل بدون Powered by -->
    <div style="margin-top:14px" class="panel">
      <div>
        <div style="font-weight:700">Quick Tips</div>
        <div style="color:var(--muted);margin-top:6px;font-size:0.92rem">
          ارفع ملف لكل شركة → اضغط Process → راجع الريبورت → حمل الملف.
        </div>
      </div>
    </div>
  </div>

  <!-- RIGHT: report & preview -->
  <aside>
    <div class="summary">
      <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div>
            <div style="font-weight:700">Mini Report</div>
            <div style="color:var(--muted);font-size:0.9rem">ملخص سريع بعد كل معالجة</div>
          </div>
          <div style="text-align:right">
            <div style="font-size:0.9rem;color:var(--muted)">Total records</div>
            <div id="totalRecords" style="font-weight:700;font-size:1.2rem">0</div>
          </div>
        </div>
        <div style="margin-top:12px">
          <table class="report-table" id="reportTable">
            <thead><tr><th>Sheet</th><th>Records</th><th>Total Amount</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </div>

      <div class="card" style="padding-bottom:14px">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div style="font-weight:700">Chart</div>
          <div style="color:var(--muted);font-size:0.9rem">Records per sheet</div>
        </div>
        <canvas id="miniChart" style="height:180px;margin-top:10px"></canvas>
      </div>

      <div class="card">
        <div style="font-weight:700;margin-bottom:8px">Preview (last processed)</div>
        <div class="preview">
          <table class="preview-table" id="previewTable">
            <thead><tr><th>Invoice ID</th><th>Received Amount</th><th>Received Date</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>
  </aside>
</div>

<!-- Footer منفصل -->
<footer>
  <div>© <span id="year"></span> <span class="brand">Automation</span> — Powered by Yazan Hijazi</div>
</footer>
</main>

<script>
const sheetsOrder = ['DeliveryOne','IDelivery','Zohal','Mailers'];
const skipRowsMap = {DeliveryOne:2, IDelivery:0, Zohal:0, Mailers:3};
let processedMap = {};
let mergedData = [];

// Greeting + date
(function initGreeting(){
  const now = new Date();
  const h = now.getHours();
  document.getElementById('timeNow').innerText = now.toLocaleString('ar-EG',{
    weekday:'long', day:'numeric', month:'short'
  });
  let greet = h<12?'صباح الخير, Waad!':h<18?'مساء الخير, Waad!':'مساء الخير — Waad!';
  document.getElementById('greetingText').textContent = greet;
  document.getElementById('year').textContent = now.getFullYear();
})();


const container = document.getElementById('sheetsContainer');
sheetsOrder.forEach(name=>{
  const row = document.createElement('div');
  row.className='sheet-row';
  row.innerHTML=`
    <div class="sheet-left">
      <strong>${name}</strong>
      <small>Upload ${name} sheet (.xls/.xlsx)</small>
      <div style="margin-top:8px;color:var(--muted);font-size:0.86rem" id="${name}Status">No file selected</div>
    </div>
    <div class="sheet-actions">
      <input type="file" accept=".xls,.xlsx" id="${name}Input">
      <div style="display:flex;gap:8px;align-items:center;margin-top:6px">
        <div class="progress-wrapper">
          <div class="progress"><div class="bar" id="${name}Bar"></div></div>
        </div>
        <div id="${name}Spinner" style="display:none"><div class="spinner"></div></div>
      </div>
      <div style="display:flex;gap:8px;margin-top:8px">
        <button class="btn ghost" id="${name}ProcessBtn">Process</button>
        <button class="btn secondary" id="${name}DownloadBtn" disabled>Download</button>
      </div>
    </div>`;
  container.appendChild(row);

  const fileInput = row.querySelector(`#${name}Input`);
  const statusEl = row.querySelector(`#${name}Status`);
  fileInput.addEventListener('change',e=>{const f=e.target.files[0]; statusEl.textContent=f?`${f.name} selected`:'No file selected';});
  row.querySelector(`#${name}ProcessBtn`).addEventListener('click',()=>processSheet(name));
  row.querySelector(`#${name}DownloadBtn`).addEventListener('click',()=>downloadSheetFile(name));
});

async function readExcel(file,skipRows=0){const buff=await file.arrayBuffer();const wb=XLSX.read(buff,{type:'array'});const sheet=wb.Sheets[wb.SheetNames[0]];return XLSX.utils.sheet_to_json(sheet,{defval:'',range:skipRows});}
function normalizeDate(v){if(!v)return'';const d=new Date(v);if(!isNaN(d.getTime()))return d.toLocaleDateString();const parts=String(v).split(/\/|-/);if(parts.length>=3){const dd=new Date(`${parts[2]}-${parts[1].padStart(2,'0')}-${parts[0].padStart(2,'0')}`);if(!isNaN(dd.getTime()))return dd.toLocaleDateString()}return String(v);}
function filterSheet(data,sheetName){
  if(!data||!data.length)return[];
  if(sheetName==='DeliveryOne')return data.map(r=>({ID:r['Contact Person']||r['Contact']||'',Amount:Number(r['Collection']||0)||0,Date:normalizeDate(r['Status Date']||r['status date']||'')}))
  else if(sheetName==='IDelivery')return data.map(r=>({ID:r['رقم الإرسالية']||r['Reference']||r['Ref']||'',Amount:Number(r['التحصيل']||0)||0,Date:normalizeDate(r['تاريخ التوصيل']||r['Date']||'')}))
  else if(sheetName==='Zohal')return data.map(r=>({ID:r['الرقم المرجعي']||r['Reference']||'',Amount:Number(r['قيمة مجموع التحصيل']||0)||0,Date:normalizeDate(r['أنشئ في']||r['created_at']||'')}))
  else if(sheetName==='Mailers')return data.map(r=>({ID:r['Reference Number2']||r['reference2']||'',Amount:Number(r['COD Value']||0)||0,Date:normalizeDate(r['Status Date']||r['status_date']||'')}))
  return[];
}
function showPreview(data){const tbody=document.querySelector('#previewTable tbody');tbody.innerHTML='';(data||[]).slice(0,200).forEach(r=>{const tr=document.createElement('tr');tr.innerHTML=`<td>${r.ID}</td><td>${r.Amount}</td><td>${r.Date}</td>`;tbody.appendChild(tr);});}
function formatNumber(n){return Number(n||0).toLocaleString();}

async function processSheet(sheetName){
  try{
    const input=document.getElementById(sheetName+'Input');
    const bar=document.getElementById(sheetName+'Bar');
    const spinner=document.getElementById(sheetName+'Spinner');
    const processBtn=document.getElementById(sheetName+'ProcessBtn');
    const downloadBtn=document.getElementById(sheetName+'DownloadBtn');
    const statusEl=document.getElementById(sheetName+'Status');
    if(!input||!input.files||!input.files[0])return alert('Please select file for '+sheetName);
    processBtn.disabled=true;bar.style.width='8%';spinner.style.display='block';statusEl.textContent='Reading file...';
    const file=input.files[0];const data=await readExcel(file,skipRowsMap[sheetName]||0);
    bar.style.width='45%';statusEl.textContent='Filtering...';
    const filtered=filterSheet(data,sheetName)||[];
    await new Promise(r=>setTimeout(r,180));
    bar.style.width='80%';statusEl.textContent=`Processed ${filtered.length} records`;
    processedMap[sheetName]={rows:filtered,count:filtered.length,totalAmount:filtered.reduce((a,b)=>a+Number(b.Amount||0),0),fileName:file.name};
    mergedData=mergedData.filter(x=>x._sourceSheet!==sheetName);
    const enriched=filtered.map(r=>({...r,_sourceSheet:sheetName}));
    mergedData=mergedData.concat(enriched);
    downloadBtn.disabled=filtered.length===0;document.getElementById('downloadMergedBtn').disabled=mergedData.length===0;
    showPreview(filtered);updateReportTable();updateChart();
    bar.style.width='100%';await new Promise(r=>setTimeout(r,260));bar.style.width='0%';spinner.style.display='none';processBtn.disabled=false;statusEl.textContent=`${file.name} — ${filtered.length} records`;
  }catch(err){console.error(err);alert('Error processing '+sheetName+': '+(err.message||err));document.getElementById(sheetName+'ProcessBtn').disabled=false;document.getElementById(sheetName+'Spinner').style.display='none';}
}

function updateReportTable(){const tbody=document.querySelector('#reportTable tbody');tbody.innerHTML='';let totalRec=0;Object.keys(processedMap).forEach(k=>{const p=processedMap[k];const tr=document.createElement('tr');tr.innerHTML=`<td>${k}</td><td>${p.count}</td><td>${formatNumber(p.totalAmount)}</td>`;tbody.appendChild(tr);totalRec+=p.count;});document.getElementById('totalRecords').innerText=totalRec;}

function downloadSheetFile(sheetName){const p=processedMap[sheetName];if(!p||!p.rows||p.rows.length===0)return alert('No processed data for '+sheetName);const ws=XLSX.utils.json_to_sheet(p.rows.map(r=>({InvoiceID:r.ID,ReceivedAmount:r.Amount,ReceivedDate:r.Date})));const wb=XLSX.utils.book_new();XLSX.utils.book_append_sheet(wb,ws,sheetName);XLSX.writeFile(wb,`Processed_${sheetName}.xlsx`);}
document.getElementById('downloadMergedBtn').addEventListener('click',()=>{if(!mergedData||mergedData.length===0)return alert('No merged data');const payload=mergedData.map(r=>({Sheet:r._sourceSheet||'',InvoiceID:r.ID,ReceivedAmount:r.Amount,ReceivedDate:r.Date}));const ws=XLSX.utils.json_to_sheet(payload);const wb=XLSX.utils.book_new();XLSX.utils.book_append_sheet(wb,ws,'Merged');XLSX.writeFile(wb,'Merged_Delivery.xlsx');});
document.getElementById('clearAllBtn').addEventListener('click',()=>{if(!confirm('Clear all processed data?'))return;processedMap={};mergedData=[];updateReportTable();updateChart();showPreview([]);sheetsOrder.forEach(s=>{const dl=document.getElementById(s+'DownloadBtn');if(dl)dl.disabled=true;const inp=document.getElementById(s+'Input');if(inp)inp.value='';const st=document.getElementById(s+'Status');if(st)st.textContent='No file selected';});document.getElementById('downloadMergedBtn').disabled=true;});

// تحديث Chart مع ألوان محددة
// تحديث Chart مع الألوان الجديدة
let chartInstance = null;
const chartColors = {
  DeliveryOne: '#ff886f', // أصفر فاتح
  IDelivery: '#f9f871',   // برتقالي
  Zohal: '#ff4f6d',       // وردي أحمر
  Mailers: '#359a98'      // وردي أحمر
};

function updateChart(){
  const ctx = document.getElementById('miniChart').getContext('2d');
  const labels = [];
  const data = [];
  const colors = [];
  Object.keys(processedMap).forEach(k=>{
    labels.push(k);
    data.push(processedMap[k].count||0);
    colors.push(chartColors[k]||'#0b67ff');
  });

  if(chartInstance){
    chartInstance.data.labels = labels;
    chartInstance.data.datasets[0].data = data;
    chartInstance.data.datasets[0].backgroundColor = colors;
    chartInstance.update();
    return;
  }

  chartInstance = new Chart(ctx,{
    type:'pie',
    data:{
      labels,
      datasets:[{
        data,
        backgroundColor: colors
      }]
    },
    options:{
      responsive: true,
      plugins:{
        legend:{position:'right'}
      }
    }
  });
}

updateChart();
</script>
</body>
</html>
